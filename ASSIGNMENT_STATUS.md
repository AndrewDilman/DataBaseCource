# Статус задания по MongoDB (курс БД)

## Что уже сделано

| Пункт задания | Статус | Где |
|---------------|--------|-----|
| Развернуть Mongo, создать БД и коллекции домена | ✅ | `docker-compose.yml` (mongodb), `mongodb-init.js` — БД `marketplace`, коллекция `products` |
| Спроектировать документы (1–2 основные + 1 вспомогательная) | ✅ | `mongodb-init.js`: основные `products`, `reviews`; вспомогательная `categories` |
| Загрузить seed-данные (>500 документов) | ✅ | `mongo-seed.js`: категории + при отсутствии продуктов 200 товаров + 300+ отзывов (суммарно >500) |
| Базовые операции (insertOne/Many, update с $set/$inc/$push/$addToSet/$arrayFilters, delete, replaceOne, upsert) | ❌ | Нет отдельных скриптов с примерами (часть есть в API: POST/PUT продукты) |
| Поиск: фильтры $and/$or/$in/$nin/$gt/$lt, проекции | ⚠️ Частично | В API: фильтр по `category_id`, проекции в GET /products |
| Индексы: одиночные, составные, partial, TTL, unique | ✅ | `mongodb-init.js` + `migrate-products-to-mongo.sh`: unique, составной, partial (products); TTL (events) |
| explain("executionStats") до/после индексов (2–3 запроса) | ⚠️ | Пример в `mongo-aggregations.md`; замеры до/после не зафиксированы |
| REST-слой 3–5 endpoint'ов | ✅ | `api/`: GET/POST/PUT products, GET report/top-by-categories, DELETE cache (5 endpoint'ов) |
| 3–5 aggregation pipelines ($match, $project, $unwind, $group, $sort, $limit; хотя бы один с $lookup) | ✅ | `mongo-aggregations.md`: 5 пайплайнов, в т.ч. с $lookup и $unwind |
| Витрина/отчет, зафиксировать результат | ❌ | Нет материализованной коллекции под отчёт |
| Спец-возможности магазина: средний ретинг, фасеты (категория/бренд/цена) | ⚠️ Частично | Агрегации по категориям и рейтингу в `mongo-aggregations.md`; фасеты по цене/бренду — нет полей в данных |
| Профайлинг: сравнить 1–2 pipeline с/без индекса | ❌ | Нет зафиксированного сравнения |
| Материализовать 1 агрегат в коллекцию (витрина) | ❌ | Нет |
| Связи 1:N, M:N; ссылки vs встраивание, обоснование | ❌ | Нет текста с обоснованием (в пайплайнах есть $lookup 1:N, N:N) |
| Транзакции (2+ коллекции, startTransaction/commit/abort) | ❌ | Нет |
| BulkWrite с разными типами операций | ❌ | Нет |
| Валидация схемы коллекции, 2–3 бизнес-правила | ✅ | `mongodb-init.js`: collMod для `products` и `reviews` (required, типы, min/max) |
| Комбинированные отчёты ($lookup, $unwind, $facet, $bucket, $graphLookup) | ⚠️ Частично | $lookup и $unwind в `mongo-aggregations.md`; $facet/$bucket/$graphLookup не использованы |
| Оптимизация запросов: 2–3 медленных, планы до/после | ❌ | Нет |
| Шардинг | ❌ | Нет |
| Кэширование: сложный отчёт в коллекцию, обновление при изменении данных | ⚠️ Частично | Отчёт кэшируется в **Redis** и инвалидируется при изменении продуктов; в отдельную коллекцию не материализуется |
| **Redis** (кэширование) | ✅ | `docker-compose`: сервис `redis`; API кэширует отчёт в Redis, инвалидация при POST/PUT продукта |

---

## Что добавлено в этом дополнении

- **Redis:** сервис `redis` в docker-compose, порт 6379; volume `redis_data`.
- **REST API (api/):** Express, MongoDB, Redis; 5 endpoint'ов: GET/POST/PUT продукты, GET отчёт «топ по категориям», DELETE сброс кэша. Отчёт кэшируется в Redis, ключ инвалидируется при создании/обновлении продукта.
- **MongoDB:** расширен `mongodb-init.js` — коллекции `reviews`, `categories`, `events` (TTL); индексы (в т.ч. составной, partial); валидация схемы для `products` и `reviews` (2–3 правила).
- **Seed:** `mongo-seed.js` — вставка категорий, при отсутствии продуктов — 200 товаров, 300+ отзывов (суммарно >500 документов).
- **Агрегации:** `mongo-aggregations.md` — примеры пайплайнов с $match, $group, $project, $sort, $limit, $lookup, $unwind; пример explain.

---

## Что осталось сделать (кратко)

1. **Документы и коллекции**  
   Доработать модель: 2 основные коллекции (например `products`, `orders` или `reviews`) + 1 вспомогательная (например `categories` или `merchants`). Добавить поля под магазин: рейтинг, бренд, цена.

2. **Seed >500 документов**  
   Отдельный скрипт/файл: `insertMany` или `mongoimport` для продуктов/заказов/отзывов в MongoDB (суммарно >500).

3. **CRUD и поиск**  
   Скрипты или код: insertOne/Many, updateOne/Many ($set, $inc, $push, $addToSet, $arrayFilters), delete, replaceOne, upsert; фильтры $and/$or/$in/$nin/$gt/$lt, проекции.

4. **Индексы**  
   Одиночные, составные, partial, TTL, unique под ключевые запросы.

5. **explain("executionStats")**  
   Для 2–3 запросов — вывод плана до и после создания индексов.

6. **REST API**  
   3–5 endpoint'ов (например: список товаров, по id, по категории, создание, отчёт по продажам/рейтингу).

7. **Aggregation pipelines**  
   3–5 пайплайнов с $match, $project, $unwind, $group, $sort, $limit; минимум один с $lookup (1:N или N:N).

8. **Витрина**  
   Один агрегат материализовать в отдельную коллекцию; описать в отчёте.

9. **Магазин: рейтинг и фасеты**  
   Средний рейтинг по товарам; фасеты по категории/бренду/цене (если добавить бренд и цену в документы).

10. **Профайлинг**  
    Сравнить 1–2 pipeline с индексом и без; 2–3 тезиса выводов.

11. **Связи**  
    Реализовать 1:N и M:N; обосновать, где ссылка, где встраивание.

12. **Транзакции**  
    Один сценарий с изменением 2+ коллекций через session.startTransaction/commit/abort.

13. **BulkWrite**  
    Пример с разными типами операций в одном BulkWrite().

14. **Валидация схемы**  
    Настроить на коллекции 2–3 бизнес-правила (например обязательные поля, диапазоны).

15. **Комбинированные отчёты**  
    Использовать $lookup, $unwind, $facet/$bucket/$graphLookup для многоуровневых отчётов (топ по категориям/брендам и т.д.).

16. **Оптимизация**  
    Выбрать 2–3 медленных запроса, оптимизировать, зафиксировать планы, время, объём, % улучшения.

17. **Шардинг**  
    Развернуть шардинг (например по `merchant_id` или `category_id`), выполнить запросы с разными shardKey.

18. **Кэширование (Mongo + Redis)**  
    - Сложный отчёт сохранять в отдельную коллекцию и обновлять при изменении данных.  
    - Дублировать тяжёлый отчёт в Redis для быстрого чтения; инвалидировать кэш при записи (добавлено в коде с Redis).

---

## Дополнение по Redis (что добавлено)

- В **docker-compose** добавлен сервис **Redis** и сервис **api** (Node.js), который ходит в MongoDB и Redis.
- **REST API** (папка `api/`): несколько endpoint'ов для продуктов и отчётов.
- **Кэш в Redis**: один тяжёлый отчёт (например «топ по категориям» или «средний рейтинг») кэшируется по ключу; при создании/обновлении продукта или отзыва ключ инвалидируется, при следующем запросе отчёт пересчитывается и снова кладётся в Redis.
- Документация по запуску и использованию — в `api/README.md` и в этом файле.

После добавления Redis и API часть пунктов (REST, кэширование, примеры агрегаций) закрыта или начата; остальное можно дорабатывать по списку выше.
