# Система резервного копирования

## Обзор
Система автоматического резервного копирования для проекта "Маркетплейс" создает полные резервные копии данных и конфигураций базы данных PostgreSQL.

## Что включает резервная копия

### 1. Данные и схема базы данных
- **Дамп данных** (`*.dump`) - бинарный дамп всех таблиц и данных в формате Custom PostgreSQL
- **Схема БД** (`schema_*.sql.gz`) - только структура таблиц, индексы, ограничения

### 2. Глобальные объекты
- **Глобальные настройки** (`globals_*.sql.gz`) - роли пользователей, табличные пространства

### 3. Настройки конкретной БД
- **Параметры конфигурации** (`db_settings_*.sql.gz`) - все параметры `pg_settings` с их значениями
- **Расширения** (`extensions_*.sql.gz`) - список установленных расширений в БД

### 4. Конфигурационные файлы сервера
- **postgresql.conf** (`postgresql.conf_*.gz`) - основной конфигурационный файл PostgreSQL
- **pg_hba.conf** (`pg_hba.conf_*.gz`) - настройки аутентификации

## Настройка

Скрипт backup.sh использует следующие переменные окружения:
- `PGHOST` - хост основной БД (по умолчанию: postgres)
- `PGPORT` - порт основной БД (по умолчанию: 5432)
- `POSTGRES_DB` - имя базы данных (по умолчанию: marketplace)
- `PGUSER` - пользователь для подключения (по умолчанию: admin)
- `PGPASSWORD` - пароль пользователя (по умолчанию: 123)
- `CRON_MODE` - режим работы (once или loop)

## Режимы работы

### Автоматический режим (loop)
Система запускается в цикле и создает резервные копии каждые 10 минут.

### Однократный режим (once)
Для однократного создания резервной копии установите переменную `CRON_MODE=once`.

## Управление сроком хранения

Система автоматически удаляет файлы резервных копий, старше 7 дней.

## Восстановление из резервной копии

### Восстановление данных:
```bash
pg_restore -h host -U user -d database_name /path/to/backup_file.dump
```

### Восстановление глобальных объектов:
```bash
psql -h host -U postgres -f globals_*.sql
```

### Восстановление расширений:
Установите расширения вручную или с помощью скрипта:
```bash
psql -h host -U user -d database_name -f extensions_*.sql
```
